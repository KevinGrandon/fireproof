/*! fireproof 2.5.1, Â© 2015 J2H2 Inc. ISC License.
 * http://github.com/casetext/fireproof.git
 */
!function(t,r){"function"==typeof define&&define.amd?define([],r):"object"==typeof exports?module.exports=r():t.Fireproof=r()}(this,function(){"use strict";function t(t,r){this._ref=t,this.then=r&&r.then?r.then.bind(r):function(t,r){return this.once("value",function(){}).then(t||null,r||null)}}function r(t,r){return"function"!=typeof t&&void 0===typeof r?t:r}function e(r,e){if(!(this instanceof t.Demux))return new t.Demux(r);arguments.length>1&&!Array.isArray(r)&&(r=Array.prototype.slice.call(arguments,0)),this._limit=void 0!==e?e:!0,this._refs=r,this._positions=r.reduce(function(t,r){return t[r.ref().toString()]={name:void 0,priority:void 0},t},{});var n=t._checkQ().defer();n.resolve([]),this._previousPromise=n.promise,this._buffer=[]}function n(t){this._items=[],this.keys=[],this.values=[],this.priorities=[],t&&(this.errorHandler=t)}function i(t,r){var e=Number(t[".key"]),n=Number(r[".key"]);return isNaN(e)||isNaN(n)?isNaN(e)?isNaN(n)?t[".key"].localeCompare(r[".key"]):1:-1:e-n}function o(t){return function(r,e){var n,o,s=r[".value"],u=e[".value"];return"object"==typeof s?(n=s[t],void 0===n&&(n=null)):n=null,"object"==typeof u?(o=u[t],void 0===o&&(o=null)):o=null,null===n&&null===o?i(r,e):null===n?-1:null===o?1:n===!1&&o===!1?i(r,e):n===!1?-1:o===!1?1:n===!0&&o===!0?i(r,e):n===!0?-1:o===!0?1:"number"==typeof n&&"number"==typeof o?n-o!==0?n-o:i(r,e):"number"==typeof n?-1:"number"==typeof o?1:"string"==typeof n&&"string"==typeof o?n===o?i(r,e):n.localeCompare(o):"string"==typeof n?-1:"string"==typeof o?1:i(r,e)}}function s(t,r){var e=t[".priority"],n=r[".priority"];if(null===e&&null===n)return i(t,r);if(null===e)return-1;if(null===n)return 1;if("number"==typeof e&&"number"==typeof n)return e-n===0?i(t,r):e-n;if("number"==typeof e)return-1;if("number"==typeof n)return 1;var o=e.localeCompare(n);return 0===o?i(t,r):o}function u(t){this._od=t.onDisconnect()}function a(r,e){if(arguments.length<1)throw new Error("Not enough arguments to Pager");if(this._mainRef=r.ref(),this._resetCurrentOperation(),this.hasNext=!0,this.hasPrevious=!1,e){var n=this.next(e);this.then=n.then.bind(n)}else{var i=t._checkQ().defer();this.then=i.promise,i.resolve([])}}function p(t){this._snap=t}var f;t._checkQ=function(){if(void 0===f)throw new Error("You must supply a Defer-style promise library to Fireproof!");return f},t.setNextTick=function(r){t.__nextTick=r},t._nextTick=function(r){t.__nextTick?t.__nextTick(r,0):setTimeout(r,0)},t._handleError=function(r){var e=t._checkQ().defer(),n=function(i,o){var s=this,u=arguments;n.id&&t.stats._finish(n.id,i),r&&"function"==typeof r&&t._nextTick(function(){r.apply(s,u)}),i?e.reject(i):e.resolve(o)};return n.promise=e.promise,n},t.bless=function(t){if(void 0===t||null===t||"function"!=typeof t.defer)throw new Error("You tried to give Fireproof an invalid Q library!");var r=t.defer();if(void 0===r||null===r||void 0===r.promise||null===r.promise||"function"!=typeof r.reject||"function"!=typeof r.resolve||"function"!=typeof r.promise.then)throw new Error("You tried to give Fireproof an invalid Q library!");f=t};var h=[];return t.prototype._wrapAuth=function(t){function r(){if(!h.authing&&h[0]){h.authing=!0;var t=h.pop();t.call(n).then(e,e)}}function e(){h.authing=!1,r()}var n=this;h.push(t),r()},t.prototype.child=function(r){return new t(this._ref.child(r))},t.prototype.parent=function(){return null===this._ref.parent()?null:new t(this._ref.parent())},t.prototype.root=function(){return new t(this._ref.root())},t.prototype.toFirebase=function(){return this._ref},t.prototype.name=function(){return this._ref.name()},t.prototype.key=function(){return this._ref.key()},t.prototype.toString=function(){return this._ref.toString()},t.prototype.auth=function(e,n,i){var o=t._handleError(n);return i=r(n,i),this._wrapAuth(function(){return this._ref.auth(e,o,i),o.promise}),o.promise},t.prototype.authWithCustomToken=function(e,n,i){var o=t._handleError(n);return i=r(n,i),this._wrapAuth(function(){return this._ref.authWithCustomToken(e,o,i),o.promise}),o.promise},t.prototype.authAnonymously=function(e,n){var i=t._handleError(e);return n=r(e,n),this._wrapAuth(function(){this._ref.authAnonymously(i,n)}),i.promise},t.prototype.authWithPassword=function(e,n,i){var o=t._handleError(n);return i=r(n,i),this._wrapAuth(function(){return this._ref.authWithPassword(e,o,i),o.promise}),o.promise},t.prototype.authWithOAuthPopup=function(e,n,i){var o=t._handleError(n);return i=r(n,i),this._wrapAuth(function(){return this._ref.authWithOAuthPopup(e,o,i),o.promise}),o.promise},t.prototype.authWithOAuthRedirect=function(e,n,i){var o=t._handleError(n);return i=r(n,i),this._wrapAuth(function(){return this._ref.authWithOAuthRedirect(e,o,i),o.promise}),o.promise},t.prototype.authWithOAuthToken=function(e,n,i,o){var s=t._handleError(i);return o=r(i,o),this._wrapAuth(function(){return this._ref.authWithOAuthToken(e,n,s,o),s.promise}),s.promise},t.prototype.getAuth=function(){return this._ref.getAuth()},t.prototype.onAuth=function(t,r){return this._ref.onAuth(t,r)},t.prototype.offAuth=function(t,r){return this._ref.offAuth(t,r)},t.prototype.unauth=function(){return this._ref.unauth()},e.prototype.get=function(r){var e=this;return e._previousPromise=e._previousPromise.then(function(){return e._buffer.length>=r?e._buffer.splice(0,r):t._checkQ().all(e._refs.map(function(t){var n,i=e._positions[t.ref().toString()].priority,o=e._positions[t.ref().toString()].name;return n=i&&o?t.startAt(i,o):i?t.startAt(i):t.startAt(),e._limit?n.limitToFirst(r-e._buffer.length):n})).then(e._concatenateResults.bind(e)).then(function(){return e._buffer.splice(0,r)})}),e._previousPromise},e.prototype._concatenateResults=function(t){var r=this,e=t.reduce(function(t,e){var n=e.ref().toString();return e.forEach(function(e){var i=r._positions[n];(i.priority!==e.getPriority()||i.name!==e.key())&&(t.push(e),i.priority=e.getPriority(),i.name=e.key())}),t},[]);r._buffer=r._buffer.concat(e).sort(function(t,r){var e=t.getPriority(),n=r.getPriority(),i=t.key(),o=r.key();return typeof e!=typeof n?null===e?-1:null===n?1:"number"==typeof e?-1:1:null===e?i.localeCompare(o):"number"==typeof e?e-n||i.localeCompare(o):"string"==typeof e?e.localeCompare(n)||i.localeCompare(o):void 0})},t.Demux=e,n.firebaseKeySort=i,n.firebaseChildSort=o,n.firebasePrioritySort=s,n.prototype.connect=function(t,r,e){function n(t){i.error=t,i.disconnect(),i.errorHandler&&i.errorHandler.call(null,t)}var i=this;i.ref=t,i.error=null,i.watchers=[t.on("child_added",function(t){var n={".key":t.key(),".value":t.val(),".priority":t.getPriority()};i._items.push(n),i._sort(r,e)},n),t.on("child_removed",function(t){var n=i.keys.indexOf(t.key());i._items.splice(n,1),i._sort(r,e)},n),t.on("child_changed",function(t){var n=i.keys.indexOf(t.key());i._items[n][".value"]=t.val(),i._sort(r,e)},n),t.on("child_moved",function(t){var n=i.keys.indexOf(t.key());i._items[n][".priority"]=t.getPriority(),i._sort(r,e)},n)]},n.prototype.disconnect=function(){this.ref&&this.watchers&&(this.ref.off("child_added",this.watchers[0]),this.ref.off("child_removed",this.watchers[1]),this.ref.off("child_changed",this.watchers[2]),this.ref.off("child_moved",this.watchers[3]),this.ref=null,this.watchers=null),this._items.length=0,this.keys.length=0,this.values.length=0,this.priorities.length=0},n.prototype._sort=function(t,r){switch(this.keys.length=0,this.values.length=0,this.priorities.length=0,t){case"child":this._items.sort(o(r));break;case"key":this._items.sort(i);break;default:this._items.sort(s)}for(var e=0;e<this._items.length;e++)this.keys[e]=this._items[e][".key"],this.values[e]=this._items[e][".value"],this.priorities[e]=this._items[e][".priority"]},t.LiveArray=n,u.prototype.cancel=function(r){var e=t._handleError(r);return this._od.cancel(e),e.promise},u.prototype.remove=function(r){var e=t._handleError(r);return this._od.remove(e),e.promise},u.prototype.set=function(r,e){var n=t._handleError(e);return this._od.set(r,n),n.promise},u.prototype.setWithPriority=function(r,e,n){var i=t._handleError(n);return this._od.setWithPriority(r,e,i),i.promise},u.prototype.update=function(r,e){var n=t._handleError(e);return this._od.update(r,n),n.promise},t.prototype.onDisconnect=function(){return new u(this._ref)},a.prototype.next=function(r){if(0===arguments.length)throw new Error("Not enough arguments to next");var e,n=this;if(n.hasNext)return n._currentOperation.then(function(){n._direction="next";var t=n._mainRef;return n._page?(e=r+1,t=t.orderByPriority().startAt(n._page.priority,n._page.key).limitToFirst(r+2)):(e=r,t=t.startAt().limitToFirst(r+1)),t.once("value")}).then(function(t){return n._handleResults(t,e)});var i=t._checkQ().defer();return i.resolve([]),i.promise},a.prototype.previous=function(r){if(0===arguments.length)throw new Error("Not enough arguments to previous");var e=this;if(e.hasPrevious)return e._currentOperation.then(function(){e._direction="previous";var t=e._mainRef;if(!e._page)throw new Error("Cannot call #previous on a Pager without calling #next first");return t=t.orderByPriority().endAt(e._page.priority,e._page.key).limitToLast(r+2),t.once("value")}).then(function(t){return e._handleResults(t,r+1)});var n=t._checkQ().defer();return n.resolve([]),n.promise},a.prototype._handleResults=function(t,r){var e=this,n=[];return t.forEach(function(t){n.push(t)}),n="next"===e._direction?e._page?n.slice(1,r):n.slice(0,r):t.numChildren()<=r?n.slice(0,t.numChildren()-1):n.slice(1,r),"next"===e._direction?(this.hasNext=t.numChildren()===r+1,this.hasPrevious=!0):(this.hasPrevious=t.numChildren()===r+1,this.hasNext=!0),n.length>0&&(e._page="next"===e._direction?{priority:n[n.length-1].getPriority(),key:n[n.length-1].key()}:{priority:n[0].getPriority(),key:n[0].key()}),e._currentOperationCount--,0===e._currentOperationCount&&e._resetCurrentOperation(),n},a.prototype._resetCurrentOperation=function(){var r=t._checkQ().defer();r.resolve(null),this._currentOperation=r.promise,this._currentOperationCount=0},t.Pager=a,t.prototype.limit=function(r){return new t(this._ref.limit(r))},t.prototype.limitToFirst=function(r){return new t(this._ref.limitToFirst(r))},t.prototype.limitToLast=function(r){return new t(this._ref.limitToLast(r))},t.prototype.orderByChild=function(r){return new t(this._ref.orderByChild(r))},t.prototype.orderByKey=function(){return new t(this._ref.orderByKey())},t.prototype.orderByValue=function(){return new t(this._ref.orderByValue())},t.prototype.orderByPriority=function(){return new t(this._ref.orderByPriority())},t.prototype.equalTo=function(r,e){return new t(e?this._ref.equalTo(r,e):this._ref.equalTo(r))},t.prototype.startAt=function(r,e){return new t(e?this._ref.startAt(r,e):this._ref.startAt(r))},t.prototype.endAt=function(r,e){return new t(e?this._ref.endAt(r,e):this._ref.endAt(r))},t.prototype.ref=function(){return new t(this._ref.ref())},t.prototype.transaction=function(r,e,n){var i=t._checkQ().defer(),o=this,s=t.stats._start("transaction",o);return o._ref.transaction(r,function(r,n,o){t.stats._finish(s,r),o=new t.Snapshot(o),e&&e(r,n,o),r?i.reject(r):i.resolve({committed:n,snapshot:o})},n),i.promise},t.prototype.on=function(r,e,n,i){var o=t._checkQ().defer(),s=!1,u=!1,a=this,p=t.stats._start("read",a);t.stats._startListener(a),a._ids||(a._ids=[]),a._ids[r]||(a._ids[r]=[]),a._ids[r].push(p),"function"!=typeof e&&(e=function(){}),"function"!=typeof n&&(n=function(){});var f=function(n,i){u||(u=!0,a._ids[r].pop(),t.stats._finish(p)),n=new t.Snapshot(n),e(n,i),s||(s=!0,o.resolve(n,i))};return f.then=o.promise.then.bind(o.promise),a._ref.on(r,f,function(e){a._ids[r].pop(),t.stats._finish(p,e),t.stats._endListener(a,e),n(e),s||(s=!0,o.reject(e))},i),f},t.prototype.off=function(r,e,n){this._ids&&this._ids[r]&&this._ids[r].length>0&&t.stats._finish(this._ids[r].pop()),t.stats._endListener(this),this._ref.off(r,e,n)},t.prototype.once=function(r,e,n,i){var o=t._checkQ().defer(),s=this,u=t.stats._start("read",s);return"function"!=typeof e&&(e=function(){}),"function"!=typeof n&&(n=function(){}),s._ref.once(r,function(r){t.stats._finish(u),r=new t.Snapshot(r),o.resolve(r),e(r)},function(r){t.stats._finish(u,r),o.reject(r),n(r)},i),o.promise},t.Snapshot=p,p.prototype.child=function(t){return new p(this._snap.child(t))},p.prototype.forEach=function(t){return this._snap.forEach(function(r){return t(new p(r))===!0?!0:void 0})},p.prototype.hasChild=function(t){return this._snap.hasChild(t)},p.prototype.hasChildren=function(){return this._snap.hasChildren()},p.prototype.numChildren=function(){return this._snap.numChildren()},p.prototype.name=function(){return this._snap.name()},p.prototype.key=function(){return this._snap.key()},p.prototype.val=function(){return this._snap.val()},p.prototype.ref=function(){return new t(this._snap.ref())},p.prototype.getPriority=function(){return this._snap.getPriority()},p.prototype.exportVal=function(){return this._snap.exportVal()},t.stats={_eventSubscribers:{}},t.stats.reset=function(){var r={},e=0;for(var n in t.stats.operationLog){var i=t.stats.operationLog[n];i.hasOwnProperty("finish")||(e++,r[n]=i)}t.stats.operationLog=r,t.stats.runningOperationCount=e,t.stats.operationCount=e},t.stats.resetListeners=function(){t.stats.listeners={},t.stats.listenCount=0},t.stats._start=function(r,e){var n=e.ref().toString(),i=Math.random().toString(36).slice(2);return t.stats.runningOperationCount++,t.stats.operationLog[i]={id:i,type:r,path:n,start:Date.now()},t.stats._emit("start",t.stats.operationLog[i]),"listen"===r&&t.stats.listenCount++,i},t.stats._finish=function(r,e){var n=t.stats.operationLog[r];if(!n)throw new Error("Fireproof: reference to unknown log event "+r);n.finish||(t.stats.runningOperationCount--,t.stats.operationCount++,n.finish=Date.now(),n.duration=n.finish-n.start,e&&(n.error=e)),n.error?t.stats._emit("error",n):t.stats._emit("finish",n)},t.stats._startListener=function(r){var e=r.ref().toString();t.stats.listeners[e]||(t.stats.listeners[e]=0),t.stats.listeners[e]++,t.stats.listenCount++,t.stats._emit("listenStarted",e)},t.stats._endListener=function(r,e){var n=r.ref().toString();t.stats.listeners[n]--,t.stats.listenCount--,t.stats._emit("listenEnded",n,e)},t.stats.getListeners=function(){return t.stats.listeners},t.stats.getListenerCount=function(){return t.stats.listenCount},t.stats.getPathCounts=function(){var r={};for(var e in t.stats.operationLog){var n=t.stats.operationLog[e];r[n.type]||(r[n.type]={}),r[n.type][n.path]?r[n.type][n.path]++:r[n.type][n.path]=1}return r},t.stats.getCounts=function(){var r={};for(var e in t.stats.operationLog){var n=t.stats.operationLog[e];r[n.type]?r[n.type]++:r[n.type]=1}return r},t.stats.on=function(r,e){if("function"==typeof r&&void 0===e&&(e=r,r=null),"function"!=typeof e)throw new Error("Non-function passed to Fireproof.stats.on");return t.stats._eventSubscribers[r]||(t.stats._eventSubscribers[r]=[]),t.stats._eventSubscribers[r].push(e),e},t.stats.off=function(r,e){if("function"==typeof r&&void 0===e&&(e=r,r=null),"function"!=typeof e)throw new Error("Non-function passed to Fireproof.stats.off");if(r){var n=t.stats._eventSubscribers[r],i=n.indexOf(e);-1!==i&&(n[i]=null)}},t.stats._emit=function(r){var e=Array.prototype.slice.call(arguments,1);t.stats._eventSubscribers[r]||(t.stats._eventSubscribers[r]=[]);var n=t.stats._eventSubscribers[r];t._nextTick(function(){for(var t=0;t<n.length;t++)null!==n[t]&&n[t].apply(null,e)})},t.stats.reset(),t.stats.resetListeners(),t.prototype.createUser=function(r,e){var n=t._handleError(e);return this._ref.createUser(r,n),n.promise},t.prototype.changeEmail=function(r,e){var n=t._handleError(e);return this._ref.changeEmail(r,n),n.promise},t.prototype.changePassword=function(r,e){var n=t._handleError(e);return this._ref.changePassword(r,n),n.promise},t.prototype.resetPassword=function(r,e){var n=t._handleError(e);return this._ref.resetPassword(r,n),n.promise},t.prototype.removeUser=function(r,e){var n=t._handleError(e);return this._ref.removeUser(r,n),n.promise},t.prototype.set=function(r,e){var n=t._handleError(e);return n.id=t.stats._start("write",this),this._ref.set(r,n),n.promise},t.prototype.update=function(r,e){var n=t._handleError(e);return n.id=t.stats._start("update",this),this._ref.update(r,n),n.promise},t.prototype.remove=function(r){var e=t._handleError(r);return e.id=t.stats._start("write",this),this._ref.remove(e),e.promise},t.prototype.push=function(r,e){var n=t._handleError(e);n.id=t.stats._start("write",this);var i=new t(this._ref.push(r,n),n.promise);return i},t.prototype.setWithPriority=function(r,e,n){var i=t._handleError(n);return i.id=t.stats._start("write",this),this._ref.setWithPriority(r,e,i),i.promise},t.prototype.setPriority=function(r,e){var n=t._handleError(e);return n.id=t.stats._start("write",this),this._ref.setPriority(r,n),n.promise},t});